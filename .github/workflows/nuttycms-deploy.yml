# ofelipeotto/devops-toolkit/.github/workflows/nuttycms-deploy.yml

name: Deploy Nutty CMS

on:

  workflow_call:

    # Inputs
    inputs:
      remote_host:
        required: true
        type: string
      remote_user:
        required: true
        type: string

    # Secrets
    secrets:
      ssh_rsa_key:
        required: true

jobs:

  deploy-panel: 

    name: ğŸš€ Deploy Panel
    runs-on: ubuntu-latest

    steps:
    - name: ğŸšš Get Latest Code
      uses: actions/checkout@v3

    #------------------------------------------------------
    # Setup SSH Key

    - name: ğŸ› ï¸ Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ssh_rsa_key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    #------------------------------------------------------
    # Backup public/uploads

    - name: ğŸ—ƒï¸ Backup public/uploads
      run: |
        ssh -i ~/.ssh/id_rsa -p 22 -o StrictHostKeyChecking=no \
          ${{ inputs.remote_user }}@${{ inputs.remote_host }} \
          "if [ -d ~/htdocs/public/uploads ]; then \
            mv ~/htdocs/public/uploads ~/uploads-backup && \
            echo 'ğŸ“ public/uploads directory moved to backup.'; \
          else \
            echo 'âš ï¸ Directory public/uploads does not exist, no backup needed.'; \
          fi"

    