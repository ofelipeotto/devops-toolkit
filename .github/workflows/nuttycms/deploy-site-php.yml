# ofelipeotto/devops-toolkit/.github/workflows/nuttycms/deploy-site-php.xml

name: Deploy Site PHP

on:

  workflow_call:

    # Inputs
    inputs:
      environment:
        required: true
        type: string
      remote_host:
        required: true
      remote_user:
        required: true

    # Secrets
    secrets:
      ssh_rsa_key:
        required: true

jobs:

  deploy-site: 

    name: 🚀 Deploy Site PHP
    runs-on: ubuntu-latest

    steps:
    - name: 🚚 Get Latest Code
      uses: actions/checkout@v3

    #------------------------------------------------------
    # Sync files

    - name: 📦 Sync Files
      uses: ./.github/actions/sync-files
      with:
        remote_host: ${{ inputs.remote_host }}
        remote_user: ${{ inputs.remote_user }}
        port: 22
        ssh_key: ${{ secrets.ssh_rsa_key }}
        source: ./site/
        destination: ~/htdocs/

    #------------------------------------------------------
    # Setup SSH Key

    - name: 🛠️ Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ssh_rsa_key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    #------------------------------------------------------
    # Run Composer Build on Server

    - name: 🛠️ Run Composer Build on Server
      run: |
        ssh -i ~/.ssh/id_rsa -p 22 -o StrictHostKeyChecking=no \
          ${{ inputs.remote_user }}@${{ inputs.remote_host }} << 'EOF'
            cd ~/htdocs

            # Instalar Composer localmente se não estiver disponível
            if ! php -r "exit((int) !file_exists('composer'));" ; then
              echo "🧰 Installing Composer..."
              curl -sS https://getcomposer.org/installer | php
              mv composer.phar composer
            fi

            php composer install --no-dev --optimize-autoloader
            php composer setup${{ inputs.environment }}
        EOF